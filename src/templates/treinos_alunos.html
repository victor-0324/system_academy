<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Treinos</title>
    <link href="{{ url_for('static', filename='css/animate.css') }}" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet">
    <link rel="shortcut icon" href="{{ url_for('static', filename='images/IMG.png') }}" type="image/x-icon">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/treinos.css') }}">

</head>

<body>
<div class="container-fluid pl-0 pr-0 bg-img clearfix parallax-window2" data-parallax="scroll">
    <nav class="navbar navbar-expand-md navbar-dark">
        <div class="container"> 
        <!-- Brand --> 
        <a class="navbar-brand mr-auto" href="/">
            <img src="/static/images/Enovare.jpg" alt="Enovare" style="width: 150px; height: 40px;">
        </a>
        <!-- Toggler/collapsibe Button -->
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#collapsibleNavbar"> <span class="navbar-toggler-icon"></span> </button>
        
        <!-- Navbar links -->
        <div class="collapse navbar-collapse" id="collapsibleNavbar">
            <ul class="navbar-nav ml-auto">
            <li class="nav-item"> <a class="nav-link" href="/treino/evolucao/{{ current_user.id }}">Evolução</a> </li>
            </ul>
            <ul class="navbar-nav ml-5">
            <li class="nav-item">
                <a class="nav-link " href="/login/logout">
                    Sair
                </a>
            </li>
        </ul>            
            <!-- <ul class="navbar-nav ml-5">
            <li class="nav-item"> <a class="nav-link btn btn-danger" href="#">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a> </li>
            </ul> -->
        </div>
        </div>
    </nav>
    <br>
    <div class="container-fluid fh5co-content-box">
        <div class="row trainers pl-0 pr-0">
            <div class="col-12 bg-50">
                <div class="quote-box2 wow bounceInDown" data-wow-delay=".25s" style="visibility: visible; animation-delay: 0.25s; animation-name: bounceInDown;">
                    <h3> TREINOS </h3>
                    <h4 class="card-title">{{ current_user.nome }} </h4>
                </div>
                <div class="desafio-container">
                <h2>Progresso Semanal</h2>
                    <div class="container">
                        <table class="table" aria-labelledby="tabelaProgressoLabel">
                            <thead>
                                <tr>
                                    <th scope="col">Seg</th>
                                    <th scope="col">Ter</th>
                                    <th scope="col">Qua</th>
                                    <th scope="col">Qui</th>
                                    <th scope="col">Sex</th>
                                </tr>
                            </thead>
                            <tbody id="tabelaProgresso" aria-labelledby="rowProgressoLabel">
                                <tr id="rowProgresso">
                                    <td id="segunda"></td>
                                    <td id="terca"></td>
                                    <td id="quarta"></td>
                                    <td id="quinta"></td>
                                    <td id="sexta"></td>
                                </tr>
                            </tbody>
                        </table>
                        <h5 id="resultadoDia" aria-label="Resultado do dia"></h5>
                        <div class="cronometro-estiloso">
                            <div id="tempo-cronometro" aria-label="Tempo do cronômetro">00:00:00</div>
                        </div>
                        <h5 id="resultadoSemana" aria-label="Resultado da semana"></h5>
                        <div class="botoes">
                            <button id="btnIniciarTreino" onclick="iniciarTreino()" aria-label="Iniciar treino">INICIAR</button>
                            <button onclick="concluirTreino()" aria-label="Finalizar treino">FINALIZAR</button>
                        </div>
                    </div>
                </div>
                {% set dias_exercicios = {} %}
                {% for exercicio in exercicios %}
                    {% set dia = exercicio.tipoTreino %}
                    {% if dias_exercicios[dia] is not defined %}
                        {% set _ = dias_exercicios.update({dia: []}) %}
                    {% endif %}
                    {% set _ = dias_exercicios[dia].append(exercicio) %}
                {% endfor %}
                {% for dia, exercicios_do_dia in dias_exercicios.items() %}
        
                    <div class="card text-center wow bounceInLeft" data-wow-delay=".25s" style="visibility: visible; animation-delay: 0.25s; animation-name: bounceInLeft;">
                        <img class="card-img-top rounded-circle img-fluid" src="/static/images/Enovare.jpg" alt="Card image">
                        <div class="card-body">
                            <table class="table text-left">
                                <thead>
                                    <tr>
                                        <th colspan="2" class="text-center dia-treino"><strong>{{ dia }}</strong></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for exercicio in exercicios_do_dia %}
                                        <tr>
                                            <td><strong>Exercício:</strong></td>
                                            <td>{{ exercicio.exercicio|capitalize }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Série:</strong></td>
                                            <td>{{ exercicio.serie }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Repetição:</strong></td>
                                            <td>{{ exercicio.repeticao }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Descanso:</strong></td>
                                            <td>{{ exercicio.descanso }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Carga:</strong></td>
                                            <td>{{ exercicio.carga }}</td>
                                        </tr>
                                        <tr>
                                            <td colspan="2">
                                                <button type="button" class="btn btn-warning" onclick="marcarConcluido(this)">Concluir Treino</button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                
                {% endfor %}
            </div>      
        </div>   
    </div> 
<script>
   // Variáveis do cronômetro
    let cronometro;
    let segundos = 0;
    let minutos = 0;
    let horas = 0;
    let cronometroIniciado = localStorage.getItem('cronometroIniciado') === 'true';
    let horaInicio;

    // Função para formatar o tempo
    function formatarTempo(tempo) {
        return tempo < 10 ? `0${tempo}` : tempo.toString();
    }

    // Função para atualizar o display do tempo
    function atualizarTempoDisplay() {
        document.getElementById('tempo-cronometro').textContent = `${formatarTempo(horas)}:${formatarTempo(minutos)}:${formatarTempo(segundos)}`;
    }

    // Função para iniciar o treino
    function iniciarTreino() {
        horaInicio = parseInt(localStorage.getItem('horaInicio')) || new Date().getTime();
        let tempoDecorrido = new Date().getTime() - horaInicio;
        horas = Math.floor(tempoDecorrido / 3600000);
        minutos = Math.floor((tempoDecorrido % 3600000) / 60000);
        segundos = Math.floor((tempoDecorrido % 60000) / 1000);
        atualizarTempoDisplay();

        cronometro = setInterval(() => {
            horas = Math.floor(tempoDecorrido / 3600000);
            minutos = Math.floor((tempoDecorrido % 3600000) / 60000);
            segundos = Math.floor((tempoDecorrido % 60000) / 1000);
            atualizarTempoDisplay();
            tempoDecorrido += 1000;
        }, 1000);

        document.getElementById('btnIniciarTreino').disabled = true;

        cronometroIniciado = true;
        localStorage.setItem('cronometroIniciado', 'true');
        localStorage.setItem('horaInicio', horaInicio);
    }

    // Função para concluir o treino
    function concluirTreino() {
        clearInterval(cronometro);
        document.getElementById('btnIniciarTreino').disabled = false;
        let diaDaSemana = new Date().getDay();
        let dias = [ 'segunda', 'terca', 'quarta', 'quinta', 'sexta'];

        let elementoDia = document.getElementById(dias[diaDaSemana]);
        if (elementoDia) {
            elementoDia.textContent = '✅';
            elementoDia.style.color = 'green';
        }

        let elementoTempo = document.getElementById('tempo-cronometro');
        if (elementoTempo) {
            let tempoAnterior = localStorage.getItem(`${dias[diaDaSemana]}Tempo`) || '00:00:00';
            let partesAnteriores = tempoAnterior.split(':');
            let totalSegundos = parseInt(partesAnteriores[2]) + segundos;
            let totalMinutos = parseInt(partesAnteriores[1]) + minutos;
            let totalHoras = parseInt(partesAnteriores[0]) + horas;

            if (totalSegundos >= 60) {
                totalSegundos -= 60;
                totalMinutos++;
            }
            if (totalMinutos >= 60) {
                totalMinutos -= 60;
                totalHoras++;
            }

            let tempoTotal = `${formatarTempo(totalHoras)}:${formatarTempo(totalMinutos)}:${formatarTempo(totalSegundos)}`;
            localStorage.setItem(`${dias[diaDaSemana]}Tempo`, tempoTotal);

            let elementoResultadoDia = document.getElementById('resultadoDia');
            if (elementoResultadoDia) {
                elementoResultadoDia.textContent = `Treino Hoje: ${tempoTotal}`;
            }

            calcularTempoSemana();
        }

        localStorage.setItem(dias[diaDaSemana], '✅');

        horas = 0;
        minutos = 0;
        segundos = 0;
        atualizarTempoDisplay();
        cronometroIniciado = false;
        localStorage.setItem('cronometroIniciado', 'false');
        localStorage.removeItem('horaInicio');

        // Reiniciar o progresso no final da semana (sábado)
        reiniciarProgresso();
    }

    // Função para calcular o tempo total de treino na semana
    function calcularTempoSemana() {
        let totalSegundos = 0;
        let dias = ['segunda', 'terca', 'quarta', 'quinta', 'sexta'];
        dias.forEach(dia => {
            let tempo = localStorage.getItem(`${dia}Tempo`);
            if (tempo) {
                let partes = tempo.split(':');
                totalSegundos += parseInt(partes[0]) * 3600 + parseInt(partes[1]) * 60 + parseInt(partes[2]);
            }
        });
        let horas = Math.floor(totalSegundos / 3600);
        totalSegundos %= 3600;
        let minutos = Math.floor(totalSegundos / 60);
        let segundos = totalSegundos % 60;
        document.getElementById('resultadoSemana').textContent = `Tempo da Semana: ${formatarTempo(horas)}:${formatarTempo(minutos)}:${formatarTempo(segundos)}`;
    }

    function marcarDiasNaoTreinados() {
        let diaDaSemana = new Date().getDay();
        let dias = [ 'segunda', 'terca', 'quarta', 'quinta', 'sexta'];
        
        // Verifica se o dia da semana é válido
        if (diaDaSemana >= 1 && diaDaSemana <= 5) {
            for (let i = 1; i < diaDaSemana; i++) {
                let progresso = localStorage.getItem(dias[i]);
                let elementoDia = document.getElementById(dias[i]);
                if (elementoDia && (!progresso || progresso !== '✅')) {
                    elementoDia.textContent = 'X';
                    elementoDia.style.color = 'red';
                    localStorage.setItem(dias[i], 'X');
                }
            }
        }
    }


    function reiniciarProgresso() {
        let diaDaSemana = new Date().getDay();

        // Verifica se o dia da semana é sábado (6) ou domingo (0)
        if (diaDaSemana === 0 ) {
            let dias = ['domingo', 'segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado'];

            dias.forEach(dia => {
                let elementoDia = document.getElementById(dia);

                // Verifica se o elemento está presente antes de tentar acessá-lo
                if (elementoDia) {
                    localStorage.removeItem(dia);
                    localStorage.removeItem(`${dia}Tempo`);
                    elementoDia.textContent = '';
                }
            });

            let elementoResultadoDia = document.getElementById('resultadoDia');
            if (elementoResultadoDia) {
                elementoResultadoDia.textContent = '';
            }

            let elementoResultadoSemana = document.getElementById('resultadoSemana');
            if (elementoResultadoSemana) {
                elementoResultadoSemana.textContent = '';
            }
        }
    }

    // Carregar progresso do LocalStorage ao recarregar a página
    window.onload = function () {
        let dias = [ 'segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado'];

        dias.forEach(dia => {
            let progresso = localStorage.getItem(dia);
            if (progresso) {
                document.getElementById(dia).textContent = progresso;
                if (progresso === '✅') {
                    document.getElementById(dia).style.color = 'green';
                } else if (progresso === 'X') {
                    document.getElementById(dia).style.color = 'red';
                }
            }
        });

        iniciarCronometroSeAtivo();

        marcarDiasNaoTreinados();
    };

    // Função para iniciar o cronômetro se estiver ativo
    function iniciarCronometroSeAtivo() {
        let estadoArmazenado = localStorage.getItem('tempoEstado');
        if (estadoArmazenado && estadoArmazenado !== 'null' && !cronometroIniciado) {
            let estado = JSON.parse(estadoArmazenado);
            segundos = estado.segundos;
            minutos = estado.minutos;
            horas = estado.horas;
            atualizarTempoDisplay();
            iniciarTreino();
            cronometroIniciado = true;
            localStorage.setItem('cronometroIniciado', 'true');
        }
    }

</script>

<script>
    function marcarConcluido(botao) {
        botao.innerHTML = 'Concluído';
        botao.style.backgroundColor = '#008000';  // Cor verde após clicar
        botao.style.color = '#ffffff';  // Texto branco após clicar
        botao.disabled = true;  // Desativa o botão após ser concluído
        }

</script>
    
<script src="{{ url_for('static', filename='js/jquery.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/bootstrap.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/parallax.js') }}"></script>
<script src="{{ url_for('static', filename='js/wow.js') }}"></script>
</body>
</html>
